# Ejecuta pruebas unitarias con Jacoco
parameters:
  - name: projectPath
    type: string
    default: "Solucion Precarga/Jar/Homologacion_Precarga"
  - name: enableCoverage
    type: string
    default: "true"
  - name: testToExecute
    type: string
    default: ""
  - name: precargaTest
    type: string
    default: ""

steps:
  - script: |
      set -euo pipefail
      echo "Valor de enableCoverage: ${{ parameters.enableCoverage }}"
      echo "Valor de ci_tests_enable_coverage_only_reports: $(ci_tests_enable_coverage_only_reports)"

  - script: |
      set -euo pipefail
      cd "$(Build.SourcesDirectory)/${{ parameters.projectPath }}"
      
      export PRECARGA="${{ parameters.precargaTest }}"
      export SCRIPTSILVER="$(scriptsilver)"
      export DESCRIPCION="$(descripcionconcepto)"
      export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
      export PATH=$JAVA_HOME/bin:$PATH

      if [ -n "${{ parameters.testToExecute }}" ]; then
        echo "Ejecutando pruebas espec√≠ficas: ${{ parameters.testToExecute }}"
        sbt "testOnly pagos.* ${{ parameters.testToExecute }}" "Test/jacocoReport"
      else
        echo "Ejecutando todas las pruebas"
        sbt jacoco
      fi
      
      # Limpiar contenedores Docker
      docker image prune -a -f
      if [ "$(docker ps -aq)" ]; then
        docker rm -f $(docker ps -aq)
      fi
    displayName: "Ejecutar pruebas"
    condition: and(succeeded(), eq('${{ parameters.enableCoverage }}', 'true'))